/**
 * Copyright (C) 1998-2008 TENCENT Inc.All Rights Reserved.
 * 
 * FileName??AuditLoger.java
 * 
 * Description?????????????????
 * History??
 * ?汾??		????				????				?????????????
 * 1.0		sunniyang		Nov 16, 2010	????
 */
package com.paipai.verticalframework.auditlog;

import java.util.Date;

import com.paipai.verticalframework.auditlog.appender.LogAppender;
import com.paipai.verticalframework.core.ObjectFactory;
import com.paipai.verticalframework.core.RequestMDC;
import com.paipai.verticalframework.log.Log;

/**
 * ???????????
 * @author sunniyang
 * @version 1.0
 * @see
 */
public class AuditLoger {

	/**
	 * ??????????????????
	 */
	private static LogAppender appender;

	/**
	 * ??????????????????????????????spring????????????
	 * ?ò???????л?????????????
	 * @see 
	 */
	private synchronized static LogAppender getAppender() {
		if (appender == null) {
			try {
				appender = ObjectFactory.getObject(LogAppender.class,
						"auditLogAppender");
			}
			catch (Throwable t) {
				Log.logError("create appender failed", t);
			}
		}

		return appender;
	}

	/**
	 * ??????????????MDC?е????????????????????????appender???????
	 * @param bizType?????????
	 * @param keyInfo????????
	 * @param opDesc??????????
	 * @see 
	 */
	public static void log(long bizType, Object keyInfo, String opDesc) {
		AuditLog log = new AuditLog();
		log.setOpTime(new Date());
		log.setSysCode(RequestMDC.getSystemID());
		log.setLoginUser(RequestMDC.getUserName());
		log.setBizType(bizType);
		log.setBsnType(RequestMDC.getRequestURI());
		log.setKeyInfo(keyInfo.toString());
		log.setOpDesc(opDesc);
		log.setClientIp(RequestMDC.getRequestIP());
		log.setSessionId(RequestMDC.getSessionID());
		Log.logKey("auditlog", log);
		LogAppender logAppender = getAppender();
		if (logAppender != null) {
			try {
				appender.append(log);
			}
			catch (Throwable t) {
				Log.logError("log audit log {0} failed", t, log);
			}
		}
	}
}
